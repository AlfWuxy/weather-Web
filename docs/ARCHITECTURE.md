# ç³»ç»Ÿæ¶æ„æ–‡æ¡£

> ç‰ˆæœ¬: 2026-01-29  
> é¡¹ç›®: å¤©æ°”å˜åŒ–ä¸ç¤¾åŒºå±…æ°‘å¥åº·é£é™©é¢„æµ‹ç³»ç»Ÿ

---

## 1. å½“å‰æ¶æ„æ¦‚è§ˆ

### 1.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®¢æˆ·ç«¯å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ æµè§ˆå™¨   â”‚  â”‚ ç®¡ç†åå° â”‚  â”‚ è€äººæ¨¡å¼ â”‚  â”‚ æ¸¸å®¢æ¨¡å¼ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Flask åº”ç”¨å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  app.py (è–„å…¥å£)  â†’  core/app.py (å·¥å‚/CLI/è“å›¾æ³¨å†Œ)        â”‚ â”‚
â”‚  â”‚  blueprints/ (è·¯ç”±å±‚)  +  core/ (é…ç½®/æ‰©å±•/å®‰å…¨/é’©å­)       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æœåŠ¡å±‚ (services/)                       â”‚
â”‚  weather / forecast / dlnm / chronic / ml / ai / community ...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤–éƒ¨æœåŠ¡å±‚                               â”‚
â”‚  QWeather / Open-Meteo / AMap / SiliconFlow / Redis             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ•°æ®å±‚                                   â”‚
â”‚  SQLAlchemy + SQLite/PostgreSQL + å¤©æ°”ç¼“å­˜/é¢„æµ‹ç¼“å­˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å½“å‰é—®é¢˜

| é—®é¢˜ | ä¸¥é‡æ€§ | è¯´æ˜ |
|------|--------|------|
| æ–‡æ¡£ä¸ä»£ç ä¸ä¸€è‡´ | ğŸ”´ é«˜ | æ¶æ„æ–‡æ¡£ä»æè¿°æ—§çš„å·¨å‹ app.py ä¸ç›®å½•ç»“æ„ |
| æœåŠ¡å±‚ä¾èµ–æ¡†æ¶ä¸Šä¸‹æ–‡ | ğŸŸ¡ ä¸­ | éƒ¨åˆ†æœåŠ¡ä»ä¾èµ– request/current_appï¼Œå½±å“å¯æµ‹æ€§ |
| åºŸå¼ƒæ¨¡å—æœªæ¸…ç† | ğŸŸ¡ ä¸­ | éƒ¨åˆ†æœåŠ¡æ–‡ä»¶å·²æ ‡è®°åºŸå¼ƒä½†ä»ä¿ç•™ |
| API è§„èŒƒåŒ–ä¸è¶³ | ğŸŸ¡ ä¸­ | ç¼ºå°‘ç»Ÿä¸€çš„ OpenAPI æ–‡æ¡£ä¸è¯·æ±‚æ ¡éªŒ |
| å¯è§‚æµ‹æ€§ä¸è¶³ | ğŸŸ¢ ä½ | ä»…æ—¥å¿—+å¯é€‰ Sentryï¼Œç¼ºå°‘æŒ‡æ ‡/Tracing |

---

## 2. ç›®æ ‡æ¶æ„ï¼ˆå¯¹é½å½“å‰å®ç°ï¼‰

### 2.1 ç›®å½•ç»“æ„

```
å¤©æ°”é¢„è­¦ç½‘ç«™/
â”œâ”€â”€ app.py                    # åº”ç”¨å…¥å£ï¼ˆè–„å±‚ï¼‰
â”œâ”€â”€ config.py                 # é™æ€é…ç½®ä¸å¸¸é‡
â”œâ”€â”€ requirements.txt
â”‚
â”œâ”€â”€ core/                     # æ ¸å¿ƒæ¡†æ¶
â”‚   â”œâ”€â”€ app.py                # åº”ç”¨å·¥å‚/è“å›¾æ³¨å†Œ/CLI
â”‚   â”œâ”€â”€ db_models.py          # SQLAlchemy æ¨¡å‹ï¼ˆ21 è¡¨ï¼‰
â”‚   â”œâ”€â”€ extensions.py         # Flask æ‰©å±•åˆå§‹åŒ–
â”‚   â”œâ”€â”€ config.py             # ç¯å¢ƒå˜é‡è§£æä¸é…ç½®æ ¡éªŒ
â”‚   â”œâ”€â”€ hooks.py              # è¯·æ±‚/å“åº”é’©å­
â”‚   â”œâ”€â”€ security.py           # CSRF/é™æµ/åŠ å¯†
â”‚   â””â”€â”€ ...                   # å…¶ä»–æ ¸å¿ƒæ¨¡å—
â”‚
â”œâ”€â”€ blueprints/               # è·¯ç”±å±‚ï¼ˆé¡µé¢ + APIï¼‰
â”‚   â”œâ”€â”€ public.py
â”‚   â”œâ”€â”€ user.py
â”‚   â”œâ”€â”€ admin.py
â”‚   â”œâ”€â”€ api.py
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ services/                 # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”œâ”€â”€ weather_service.py
â”‚   â”œâ”€â”€ ml_prediction_service.py
â”‚   â”œâ”€â”€ dlnm_risk_service.py
â”‚   â”œâ”€â”€ ai_question_service.py
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ parsers.py
â”‚   â”œâ”€â”€ validators.py
â”‚   â””â”€â”€ error_handlers.py
â”‚   â”œâ”€â”€ validators.py        # è¾“å…¥éªŒè¯
â”‚   â”œâ”€â”€ parsers.py           # æ•°æ®è§£æ (parse_age, parse_intç­‰)
â”‚   â”œâ”€â”€ helpers.py           # é€šç”¨å·¥å…· (å¤©æ°”ç¼“å­˜, é€šçŸ¥ç­‰)
â”‚   â””â”€â”€ response.py          # JSONå“åº”å°è£…
â”‚
â”œâ”€â”€ templates/                # æ¨¡æ¿ (ä¿æŒç°çŠ¶)
â”œâ”€â”€ static/                   # é™æ€èµ„æº (ä¿æŒç°çŠ¶)
â”œâ”€â”€ data/                     # æ•°æ®æ–‡ä»¶
â”œâ”€â”€ tests/                    # æµ‹è¯•
â””â”€â”€ scripts/                  # ç¦»çº¿è„šæœ¬
    â”œâ”€â”€ import_data.py
    â”œâ”€â”€ train_model.py       # åˆå¹¶åçš„è®­ç»ƒè„šæœ¬
    â””â”€â”€ analyze_data.py      # åˆå¹¶åçš„åˆ†æè„šæœ¬
```

### 2.2 æ¨¡å—è¾¹ç•Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    blueprints/ (è§†å›¾å±‚)                         â”‚
â”‚  æ¥æ”¶HTTPè¯·æ±‚ â†’ è°ƒç”¨æœåŠ¡ â†’ æ¸²æŸ“æ¨¡æ¿/è¿”å›JSON                    â”‚
â”‚  ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œä»…åšè·¯ç”±è½¬å‘å’Œæ•°æ®æ ¼å¼åŒ–                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       services/ (æœåŠ¡å±‚)                        â”‚
â”‚  ä¸šåŠ¡é€»è¾‘ï¼šé£é™©è®¡ç®—ã€é¢„æµ‹ç®—æ³•ã€å¤–éƒ¨APIè°ƒç”¨                      â”‚
â”‚  å°½é‡å‡å°‘å¯¹ Flask request/session çš„ç›´æ¥ä¾èµ–                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      core/db_models.py (æ¨¡å‹å±‚)                 â”‚
â”‚  SQLAlchemyæ¨¡å‹å®šä¹‰ï¼Œçº¯æ•°æ®ç»“æ„                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        utils/ (å·¥å…·å±‚)                          â”‚
â”‚  é€šç”¨å·¥å…·å‡½æ•°ï¼Œæ— çŠ¶æ€ï¼Œå¯å¤ç”¨                                   â”‚
â”‚  éªŒè¯ã€è§£æã€æ ¼å¼åŒ–ã€ç¼“å­˜ç­‰                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 çŸ­æœŸæ”¹è¿›æ¸…å•ï¼ˆ1-2 å‘¨ï¼‰

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ¶æ„æ–‡æ¡£ä¸æ¦‚è§ˆå¯¹é½ | âœ… | æ›´æ–° `docs/ARCHITECTURE.md` ä¸ `PROJECT_OVERVIEW.md` |
| æ¸…ç†åºŸå¼ƒæ¨¡å— | â³ | æ ‡è®°åºŸå¼ƒæœåŠ¡è¿ç§»è®¡åˆ’ï¼Œç§»é™¤æœªè¢«å¼•ç”¨ä»£ç  |
| API è§„èŒƒåŒ– | â³ | å¢åŠ  OpenAPI è‰æ¡ˆ + åŸºç¡€è¯·æ±‚æ ¡éªŒ |
| æµ‹è¯•è¡¥å¼º | â³ | è¦†ç›–å…³é”®æœåŠ¡ä¸ API çš„è¾¹ç•Œç”¨ä¾‹ |

---

## 3. æ•°æ®æ¨¡å‹

### 3.1 ERå›¾

```
User 1â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€n HealthRiskAssessment
  â”‚                        
  â”‚ 1                      
  â”œâ”€â”€n FamilyMember 1â”€â”€1 FamilyMemberProfile
  â”‚        â”‚
  â”‚        â””â”€â”€n HealthDiary
  â”‚        â””â”€â”€n MedicationReminder
  â”‚
  â””â”€â”€n Notification
  
Community 1â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€n MedicalRecord
         1â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€n WeatherData (æŒ‰location)

WeatherCache (å¤©æ°”ç¼“å­˜ï¼ŒæŒ‰location)
ForecastCache (é¢„æŠ¥ç¼“å­˜ï¼ŒæŒ‰location+days)
WeatherAlert (å¤©æ°”é¢„è­¦)
AuditLog (å®¡è®¡æ—¥å¿—)
```

### 3.2 æ¨¡å‹æ¸…å•

| æ¨¡å‹ | ç”¨é€” | å…³è” |
|------|------|------|
| User | ç”¨æˆ·è´¦æˆ· | â†’ FamilyMember, HealthRiskAssessment, Notification |
| GuestUser | æ¸¸å®¢(å†…å­˜) | - |
| MedicalRecord | ç—…å†è®°å½• | â†’ Community |
| WeatherData | å¤©æ°”æ•°æ® | æŒ‰date+location |
| WeatherCache | å¤©æ°”ç¼“å­˜ | æŒ‰location |
| ForecastCache | é¢„æŠ¥ç¼“å­˜ | æŒ‰location+days |
| Community | ç¤¾åŒºä¿¡æ¯ | - |
| HealthRiskAssessment | å¥åº·è¯„ä¼° | â†’ User |
| WeatherAlert | å¤©æ°”é¢„è­¦ | - |
| FamilyMember | å®¶åº­æˆå‘˜ | â†’ User |
| FamilyMemberProfile | æˆå‘˜ç”»åƒ | â†’ FamilyMember |
| HealthDiary | å¥åº·æ—¥è®° | â†’ User, FamilyMember |
| MedicationReminder | ç”¨è¯æé†’ | â†’ User, FamilyMember |
| Notification | ç«™å†…é€šçŸ¥ | â†’ User |
| AuditLog | å®¡è®¡æ—¥å¿— | - |

---

## 4. APIç«¯ç‚¹

### 4.1 é¡µé¢è·¯ç”±

| è·¯ç”± | æ–¹æ³• | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| `/` | GET | å…¬å¼€ | é¦–é¡µ |
| `/login` | GET/POST | å…¬å¼€ | ç™»å½• |
| `/register` | GET/POST | å…¬å¼€ | æ³¨å†Œ |
| `/guest` | GET | å…¬å¼€ | æ¸¸å®¢å…¥å£ |
| `/dashboard` | GET | ç™»å½• | ç”¨æˆ·ä»ªè¡¨æ¿ |
| `/health-assessment` | GET/POST | ç™»å½• | å¥åº·è¯„ä¼° |
| `/community-risk` | GET | ç™»å½• | ç¤¾åŒºé£é™© |
| `/profile` | GET/POST | ç™»å½• | ä¸ªäººè®¾ç½® |
| `/family-members` | GET/POST | ç™»å½• | å®¶åº­æˆå‘˜ |
| `/health-diary` | GET/POST | ç™»å½• | å¥åº·æ—¥è®° |
| `/ai-qa` | GET | ç™»å½• | AIé—®ç­” |
| `/forecast-7day` | GET | ç™»å½• | 7å¤©é¢„æµ‹ |
| `/chronic-risk` | GET | ç™»å½• | æ…¢ç—…é£é™© |
| `/ml-prediction` | GET | ç™»å½• | MLé¢„æµ‹ |
| `/admin/*` | GET/POST | ç®¡ç†å‘˜ | ç®¡ç†åå° |
| `/analysis/*` | GET/POST | ç™»å½• | æ•°æ®åˆ†æ |

### 4.2 REST API

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/weather/current` | GET | å½“å‰å¤©æ°” |
| `/api/community/list` | GET | ç¤¾åŒºåˆ—è¡¨ |
| `/api/community/risk-map` | GET | é£é™©åœ°å›¾ |
| `/api/forecast/7day` | POST | 7å¤©é¢„æµ‹ |
| `/api/chronic/individual` | POST | ä¸ªä½“æ…¢ç—…é£é™© |
| `/api/chronic/rules-version` | GET | è§„åˆ™ç‰ˆæœ¬ |
| `/api/ml/predict` | POST | MLé¢„æµ‹ |
| `/api/ml/status` | GET | MLçŠ¶æ€ |
| `/api/dlnm/risk` | POST | DLNMé£é™© |
| `/api/ai/ask` | POST | AIé—®ç­” |
| `/api/alert/comprehensive` | POST | ç»¼åˆé¢„è­¦ |

---

## 5. æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ |
|------|------|
| Webæ¡†æ¶ | Flask 2.3.3 |
| ORM | SQLAlchemy 2.0.23 (Flask-SQLAlchemy) |
| è®¤è¯ | Flask-Login 0.6.3 |
| é™æµ | Flask-Limiter 3.7.0 |
| æ•°æ®åº“ | SQLite (å¼€å‘), å¯åˆ‡æ¢PostgreSQL |
| æ¨¡æ¿ | Jinja2 3.1.2 |
| å‰ç«¯ | Bootstrap + Chart.js + é«˜å¾·åœ°å›¾ |
| ML | scikit-learn 1.3+ |
| æ•°æ® | pandas 2.1.3, numpy 1.26.4 |
| æŠ¥å‘Š | ReportLab (PDF), openpyxl (Excel) |

---

## 6. éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Nginx (åå‘ä»£ç†)            â”‚
â”‚              :80 / :443                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Gunicorn (WSGIæœåŠ¡å™¨)          â”‚
â”‚              :5000 (å†…éƒ¨)               â”‚
â”‚           workers = 4                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Flask Application             â”‚
â”‚              app.py                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           SQLite / PostgreSQL           â”‚
â”‚          storage/health_weather.db      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. æœåŠ¡å™¨è¿ç»´æŒ‡å—

### 7.1 æœåŠ¡å™¨ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|------|
| æœåŠ¡å™¨IP | 172.245.126.42 |
| æ“ä½œç³»ç»Ÿ | Debian 12 |
| é¡¹ç›®è·¯å¾„ | /opt/case-weather |
| Pythonç‰ˆæœ¬ | 3.11.2 |
| è™šæ‹Ÿç¯å¢ƒ | /opt/case-weather/venv |
| æ•°æ®åº“ | /opt/case-weather/storage/health_weather.db |
| æœåŠ¡åç§° | case-weather.service |
| ç«¯å£ | 5000 |

### 7.2 æœåŠ¡ç®¡ç†å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡
systemctl start case-weather

# åœæ­¢æœåŠ¡
systemctl stop case-weather

# é‡å¯æœåŠ¡
systemctl restart case-weather

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status case-weather

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
journalctl -u case-weather -f

# æŸ¥çœ‹æœ€è¿‘50æ¡æ—¥å¿—
journalctl -u case-weather --no-pager -n 50
```

### 7.3 ä»£ç éƒ¨ç½²

```bash
# ä»æœ¬åœ°åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨ï¼ˆæ’é™¤æ•°æ®åº“å’Œæ•æ„Ÿæ–‡ä»¶ï¼‰
rsync -avz \
  --exclude "venv" \
  --exclude ".venv" \
  --exclude "__pycache__" \
  --exclude ".git" \
  --exclude ".DS_Store" \
  --exclude ".env" \
  --exclude "instance/health_weather.db" \
  --exclude "storage" \
  /Users/imac/Downloads/case-weather/ \
  root@172.245.126.42:/opt/case-weather/

# é‡å¯æœåŠ¡ä½¿æ›´æ–°ç”Ÿæ•ˆ
ssh root@172.245.126.42 "systemctl restart case-weather"
```

**é‡è¦**ï¼š`.env` è¢«æ’é™¤ï¼Œä¸ä¼šè¢«è¦†ç›–ã€‚æ•°æ®åº“é»˜è®¤ä½äº `/opt/case-weather/storage/health_weather.db`ï¼ˆä»“åº“å¤–ï¼‰ï¼›è‹¥æœ¬åœ°å­˜åœ¨ `storage/` ç›®å½•ä¹Ÿä¼šè¢«æ’é™¤ã€‚

### 7.4 æ•°æ®åº“å¤‡ä»½ç­–ç•¥

#### å¤‡ä»½æœºåˆ¶

| é¡¹ç›® | è¯¦æƒ… |
|------|------|
| å¤‡ä»½ä½ç½® | `/opt/case-weather/backups/` |
| å¤‡ä»½é¢‘ç‡ | æ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨æ‰§è¡Œ (Cron) |
| ä¿ç•™å¤©æ•° | 30å¤©ï¼ˆè‡ªåŠ¨åˆ é™¤æ—§å¤‡ä»½ï¼‰ |
| å¤‡ä»½æ ¼å¼ | `.db.gz` (SQLite + gzipå‹ç¼©) |

#### å¤‡ä»½è„šæœ¬ (`/opt/case-weather/scripts/backup.sh`)

```bash
#!/bin/bash
BACKUP_DIR=/opt/case-weather/backups
DB_FILE=/opt/case-weather/storage/health_weather.db
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE=$BACKUP_DIR/health_weather_$DATE.db

mkdir -p $BACKUP_DIR
sqlite3 $DB_FILE ".backup $BACKUP_FILE"
gzip $BACKUP_FILE
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete
```

#### Cronå®šæ—¶ä»»åŠ¡

```bash
# æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
crontab -l

# å½“å‰é…ç½®ï¼ˆæ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œï¼‰
0 3 * * * /opt/case-weather/scripts/backup.sh >> /opt/case-weather/backups/backup.log 2>&1
```

#### æ‰‹åŠ¨å¤‡ä»½

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
/opt/case-weather/scripts/backup.sh

# æŸ¥çœ‹å¤‡ä»½åˆ—è¡¨
ls -lh /opt/case-weather/backups/
```

#### ä¸‹è½½å¤‡ä»½åˆ°æœ¬åœ°

```bash
# åœ¨æœ¬åœ°æ‰§è¡Œ
cd /Users/imac/Downloads/case-weather
./scripts/download_backup.sh

# æˆ–æ‰‹åŠ¨ä¸‹è½½
scp root@172.245.126.42:/opt/case-weather/backups/*.gz ./backups/
```

#### æ¢å¤æ•°æ®åº“

```bash
# 1. åœæ­¢æœåŠ¡
systemctl stop case-weather

# 2. è§£å‹å¤‡ä»½
cd /opt/case-weather/backups
gunzip health_weather_YYYYMMDD_HHMMSS.db.gz

# 3. å¤‡ä»½å½“å‰æ•°æ®åº“ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
cp /opt/case-weather/storage/health_weather.db /opt/case-weather/storage/health_weather.db.old

# 4. æ¢å¤æ•°æ®åº“
cp health_weather_YYYYMMDD_HHMMSS.db /opt/case-weather/storage/health_weather.db

# 5. é‡å¯æœåŠ¡
systemctl restart case-weather
```

### 7.5 ç¯å¢ƒå˜é‡é…ç½®

ç¯å¢ƒå˜é‡å­˜å‚¨åœ¨ `/opt/case-weather/.env` æ–‡ä»¶ä¸­ï¼ˆæƒé™ 600ï¼‰ï¼š

```bash
# Flaské…ç½®
FLASK_ENV=production
SECRET_KEY=your_secret_key

# å’Œé£å¤©æ°”APIï¼ˆä¸»æ¥æºï¼‰
QWEATHER_KEY=YOUR_QWEATHER_KEY
QWEATHER_API_BASE=https://mj76x98pfn.re.qweatherapi.com/v7

# Open-Meteoï¼ˆå…œåº•ï¼Œæ— éœ€ Keyï¼‰
# æ— éœ€é…ç½®ï¼Œç³»ç»Ÿä¼šåœ¨ QWeather å¤±è´¥æ—¶è‡ªåŠ¨å¯ç”¨

# é«˜å¾·åœ°å›¾API
AMAP_KEY=your_amap_key

# SiliconFlow AI
SILICONFLOW_API_KEY=your_siliconflow_key

# æœ¬åœ°éƒ¨ç½²/åŒæ­¥ï¼ˆä¸ä¸Šä¼ æœåŠ¡å™¨ï¼‰
DEPLOY_SERVER=172.245.126.42
DEPLOY_USER=root
DEPLOY_PROJECT_DIR=/opt/case-weather
DEPLOY_LOCAL_DIR=/path/to/case-weather
# æ¨èä½¿ç”¨ SSH Keyï¼›æ— éœ€ä¿å­˜å¯†ç 
# SSHPASS=your_ssh_password
```

`scripts/deploy.sh` / `scripts/sync.sh` / `scripts/download_backup.sh` ä¼šè¯»å–æœ¬åœ° `.env`ï¼Œä¼˜å…ˆä½¿ç”¨ SSH Keyï¼›å¦‚éœ€å¯†ç æ–¹å¼å†é…ç½® `SSHPASS`ã€‚`.env` ä¸ä¼šè¢«åŒæ­¥åˆ°æœåŠ¡å™¨ã€‚

### 7.6 å¸¸è§é—®é¢˜æ’æŸ¥

#### 1. æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
journalctl -u case-weather --no-pager -n 100 | grep -E "(ERROR|Exception)"

# æ‰‹åŠ¨æµ‹è¯•åº”ç”¨
cd /opt/case-weather
/opt/case-weather/venv/bin/python -c "from app import app; print('OK')"
```

#### 2. æ•°æ®åº“åˆ—ç¼ºå¤±é”™è¯¯

```bash
# æ£€æŸ¥è¡¨ç»“æ„
sqlite3 /opt/case-weather/storage/health_weather.db "PRAGMA table_info(è¡¨å);"

# æ·»åŠ ç¼ºå¤±åˆ—
sqlite3 /opt/case-weather/storage/health_weather.db "ALTER TABLE è¡¨å ADD COLUMN åˆ—å TEXT;"

# æˆ–ä½¿ç”¨ db.create_all() åŒæ­¥æ‰€æœ‰è¡¨
cd /opt/case-weather
/opt/case-weather/venv/bin/python -c "from app import app, db; 
with app.app_context(): db.create_all(); print('Done')"
```

#### 3. å¤©æ°”APIè¿”å›æ¨¡æ‹Ÿæ•°æ®

æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `QWEATHER_KEY` å’Œ `QWEATHER_API_BASE` æ˜¯å¦æ­£ç¡®é…ç½®ï¼›è‹¥ QWeather å¤±è´¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›é€€ Open-Meteoã€‚

```bash
# æµ‹è¯•API
curl -s --compressed "https://mj76x98pfn.re.qweatherapi.com/v7/weather/now?key=YOUR_KEY&location=116.20,29.27"
```

---
