{% extends "base.html" %}

{% block title %}ç¤¾åŒºé£é™©åœ°å›¾ - å¤©æ°”å¥åº·é£é™©é¢„æµ‹ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 600px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    .amap-marker {
        cursor: pointer;
    }
    .info-window {
        min-width: 250px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-map"></i> ç¤¾åŒºå¥åº·é£é™©åœ°å›¾</h2>
            <p class="text-muted">ç›´è§‚å±•ç¤ºå„ç¤¾åŒºçš„å¥åº·é£é™©åˆ†å¸ƒæƒ…å†µ</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-9 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-geo-alt"></i> é£é™©åˆ†å¸ƒåœ°å›¾</h5>
                </div>
                <div class="card-body p-3">
                    <div id="map"></div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> å›¾ä¾‹è¯´æ˜</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <span class="badge bg-success">ä½é£é™©</span>
                        <p class="small text-muted mb-0">è„†å¼±æ€§æŒ‡æ•° < 30</p>
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-warning">ä¸­é£é™©</span>
                        <p class="small text-muted mb-0">è„†å¼±æ€§æŒ‡æ•° 30-60</p>
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-danger">é«˜é£é™©</span>
                        <p class="small text-muted mb-0">è„†å¼±æ€§æŒ‡æ•° > 60</p>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-3">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list"></i> ç¤¾åŒºé£é™©æ’å</h5>
                    <button class="btn btn-light btn-sm" id="refreshRiskMap" type="button">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                    <div class="list-group list-group-flush" id="community-list">
                        {% for community in communities %}
                            <a href="#" class="list-group-item list-group-item-action" 
                               data-lat="{{ community.latitude }}" 
                               data-lng="{{ community.longitude }}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ community.name }}</h6>
                                    {% if community.risk_level == 'é«˜' %}
                                        <span class="badge bg-danger">{{ community.risk_level }}</span>
                                    {% elif community.risk_level == 'ä¸­' %}
                                        <span class="badge bg-warning">{{ community.risk_level }}</span>
                                    {% else %}
                                        <span class="badge bg-success">{{ community.risk_level }}</span>
                                    {% endif %}
                                </div>
                                <p class="mb-1 small text-muted">
                                    äººå£ï¼š{{ community.population or 'N/A' }}
                                </p>
                                <small class="text-muted">
                                    è„†å¼±æ€§æŒ‡æ•°ï¼š{{ community.vulnerability_index|round(2) if community.vulnerability_index else 'N/A' }}
                                </small>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- ç®¡æ§å»ºè®® -->
            <div class="card shadow-sm">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-lightbulb"></i> ç®¡æ§å»ºè®®</h5>
                </div>
                <div class="card-body p-2" id="managementSuggestions">
                    <p class="text-muted small mb-0">ç‚¹å‡»åˆ·æ–°æŒ‰é’®åŠ è½½å»ºè®®...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if amap_security_js_code %}
<script type="text/javascript">
    window._AMapSecurityConfig = {
        securityJsCode: {{ amap_security_js_code|tojson }}
    };
</script>
{% endif %}
<script src="https://webapi.amap.com/maps?v=2.0&key={{ amap_key|urlencode }}&plugin=AMap.Scale,AMap.ToolBar"></script>
<script>
// ç¤¾åŒºæ•°æ®
var communities = {{ communities|tojson|safe }};

// åˆå§‹åŒ–é«˜å¾·åœ°å›¾ï¼ˆéƒ½æ˜Œå¿ä¸­å¿ƒ - æ±Ÿè¥¿çœä¹æ±Ÿå¸‚ï¼‰
var map = new AMap.Map('map', {
    zoom: 12,
    center: [116.2, 29.27],  // éƒ½æ˜Œå¿åæ ‡
    mapStyle: 'amap://styles/normal',
    viewMode: '2D'
});

// å¼‚æ­¥åŠ è½½æ§ä»¶æ’ä»¶
AMap.plugin(['AMap.Scale', 'AMap.ToolBar'], function() {
    map.addControl(new AMap.Scale());
    map.addControl(new AMap.ToolBar());
});

// æ ¹æ®é£é™©ç­‰çº§è·å–é¢œè‰²
function getRiskColor(riskLevel) {
    switch(riskLevel) {
        case 'é«˜': return '#dc2626';
        case 'ä¸­': return '#d97706';
        case 'ä½': return '#0e9f6e';
        default: return '#6b7280';
    }
}

// å­˜å‚¨æ‰€æœ‰æ ‡è®°
var markers = [];
var riskMarkers = [];  // é£é™©æ•°æ®æ ‡è®°
var riskMarkerCoords = {};
var baseMarkersCleared = false;

// éƒ½æ˜Œå¿å„ç¤¾åŒº/æ‘é•‡åæ ‡æ•°æ®ï¼ˆGCJ-02ï¼‰
var communityCoords = {{ community_coords|tojson|safe }};

function toRadians(value) {
    return value * Math.PI / 180;
}

function haversineDistance(a, b) {
    var lon1 = toRadians(a[0]);
    var lat1 = toRadians(a[1]);
    var lon2 = toRadians(b[0]);
    var lat2 = toRadians(b[1]);
    var dlon = lon2 - lon1;
    var dlat = lat2 - lat1;
    var sinDlat = Math.sin(dlat / 2);
    var sinDlon = Math.sin(dlon / 2);
    var aa = sinDlat * sinDlat + Math.cos(lat1) * Math.cos(lat2) * sinDlon * sinDlon;
    return 2 * 6371000 * Math.asin(Math.sqrt(aa));
}

function computeBoundaryRadii(coordsMap) {
    var names = Object.keys(coordsMap || {});
    var radii = {};
    var maxRadius = 1200;

    names.forEach(function(name) {
        var center = coordsMap[name];
        if (!center || center.length !== 2) {
            return;
        }
        var minDistance = Infinity;
        names.forEach(function(other) {
            if (other === name) {
                return;
            }
            var target = coordsMap[other];
            if (!target || target.length !== 2) {
                return;
            }
            var dist = haversineDistance(center, target);
            if (dist < minDistance) {
                minDistance = dist;
            }
        });

        var radius = Math.floor(minDistance * 0.45);
        if (!isFinite(radius) || radius <= 0) {
            radius = 600;
        }
        radii[name] = Math.min(radius, maxRadius);
    });

    return radii;
}

var communityBoundaryRadii = computeBoundaryRadii(communityCoords);

function getBoundaryRadius(name) {
    return communityBoundaryRadii[name] || 600;
}

function clearBaseMarkers() {
    if (baseMarkersCleared) {
        return;
    }
    markers.forEach(function(item) {
        if (item.circle) {
            map.remove(item.circle);
        }
        if (item.text) {
            map.remove(item.text);
        }
    });
    markers = [];
    baseMarkersCleared = true;
}

function safeText(value, fallback) {
    if (value === undefined || value === null) {
        return fallback || '';
    }
    return String(value);
}

function toNumber(value, fallback) {
    if (value === undefined || value === null || value === '') {
        return fallback;
    }
    var num = Number(value);
    if (!Number.isFinite(num)) {
        return fallback;
    }
    return num;
}

function formatNumber(value, digits, fallbackText) {
    var num = toNumber(value, null);
    if (num === null) {
        return fallbackText;
    }
    return num.toFixed(digits);
}

function escapeHtml(value) {
    return safeText(value, '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function createMarkerWithContent(options, contentData) {
    var fallback = contentData ? contentData.fallback : '';
    if (contentData && contentData.node) {
        options.content = contentData.node;
    }
    try {
        var marker = new AMap.Marker(options);
        if (fallback && marker.getContent) {
            var content = marker.getContent();
            if (typeof content === 'string' && content.indexOf('[object') === 0) {
                marker.setContent(fallback);
            }
        }
        return marker;
    } catch (error) {
        if (fallback) {
            options.content = fallback;
            return new AMap.Marker(options);
        }
        throw error;
    }
}

function createInfoWindowWithContent(options, contentData) {
    var fallback = contentData ? contentData.fallback : '';
    if (contentData && contentData.node) {
        options.content = contentData.node;
    } else if (fallback) {
        options.content = fallback;
    }
    try {
        var infoWindow = new AMap.InfoWindow(options);
        if (fallback && infoWindow.getContent) {
            var content = infoWindow.getContent();
            if (typeof content === 'string' && content.indexOf('[object') === 0) {
                infoWindow.setContent(fallback);
            }
        }
        return infoWindow;
    } catch (error) {
        if (fallback) {
            options.content = fallback;
            return new AMap.InfoWindow(options);
        }
        throw error;
    }
}

// åˆ›å»ºè‡ªå®šä¹‰æ ‡æ³¨æ ·å¼
function createMarkerContent(name, riskLevel, score) {
    var levelText = safeText(riskLevel, '');
    var bgColor = levelText === 'é«˜é£é™©' ? '#dc2626' :
                  levelText === 'ä¸­é£é™©' ? '#d97706' : '#0e9f6e';
    var nameText = safeText(name, '');
    var shortName = nameText.length > 4 ? nameText.substring(0, 4) : nameText;
    var scoreText = formatNumber(score, 0, '--');

    var container = document.createElement('div');
    container.style.cssText = [
        'background:' + bgColor,
        'color:white',
        'padding:6px 10px',
        'border-radius:20px',
        'font-size:12px',
        'font-weight:bold',
        'white-space:nowrap',
        'box-shadow:0 2px 8px rgba(0,0,0,0.3)',
        'border:2px solid white',
        'text-align:center',
        'min-width:60px'
    ].join(';');

    var nameDiv = document.createElement('div');
    nameDiv.textContent = shortName;
    var scoreDiv = document.createElement('div');
    scoreDiv.style.fontSize = '10px';
    scoreDiv.style.opacity = '0.9';
    scoreDiv.textContent = scoreText + 'åˆ†';

    container.appendChild(nameDiv);
    container.appendChild(scoreDiv);

    var fallbackHtml = '<div style="' +
        'background:' + bgColor + ';' +
        'color:white;' +
        'padding:6px 10px;' +
        'border-radius:20px;' +
        'font-size:12px;' +
        'font-weight:bold;' +
        'white-space:nowrap;' +
        'box-shadow:0 2px 8px rgba(0,0,0,0.3);' +
        'border:2px solid white;' +
        'text-align:center;' +
        'min-width:60px;' +
        '">' +
        '<div>' + escapeHtml(shortName) + '</div>' +
        '<div style="font-size:10px;opacity:0.9;">' + escapeHtml(scoreText) + 'åˆ†</div>' +
        '</div>';

    return {
        node: container,
        fallback: fallbackHtml
    };
}

function buildCommunityInfoContent(community, markerColor) {
    var nameText = safeText(community && community.name, '--');
    var riskText = safeText(community && community.risk_level, '--');
    var populationValue = toNumber(community && community.population, null);
    var populationText = populationValue === null ? 'N/A' : Math.round(populationValue).toLocaleString();
    var vulnerabilityText = formatNumber(community && community.vulnerability_index, 2, 'N/A');

    var wrapper = document.createElement('div');
    wrapper.className = 'p-3';
    wrapper.style.minWidth = '280px';

    var title = document.createElement('h6');
    title.className = 'fw-bold mb-3';
    title.style.color = markerColor;
    title.style.borderBottom = '2px solid ' + markerColor;
    title.style.paddingBottom = '8px';
    title.textContent = 'ğŸ“ ' + nameText;

    var riskRow = document.createElement('div');
    riskRow.className = 'mb-2';
    var riskLabel = document.createElement('span');
    riskLabel.className = 'text-secondary';
    riskLabel.textContent = 'é£é™©ç­‰çº§ï¼š';
    var riskBadge = document.createElement('span');
    riskBadge.className = 'badge';
    riskBadge.style.backgroundColor = markerColor;
    riskBadge.style.fontSize = '0.85rem';
    riskBadge.textContent = riskText + 'é£é™©';
    riskRow.appendChild(riskLabel);
    riskRow.appendChild(riskBadge);

    var populationRow = document.createElement('div');
    populationRow.className = 'mb-2';
    var populationLabel = document.createElement('span');
    populationLabel.className = 'text-secondary';
    populationLabel.textContent = 'äººå£æ•°é‡ï¼š';
    var populationStrong = document.createElement('strong');
    populationStrong.textContent = populationText;
    populationRow.appendChild(populationLabel);
    populationRow.appendChild(populationStrong);
    populationRow.appendChild(document.createTextNode(' äºº'));

    var viRow = document.createElement('div');
    viRow.className = 'mb-2';
    var viLabel = document.createElement('span');
    viLabel.className = 'text-secondary';
    viLabel.textContent = 'è„†å¼±æ€§æŒ‡æ•°ï¼š';
    var viStrong = document.createElement('strong');
    viStrong.style.color = markerColor;
    viStrong.textContent = vulnerabilityText;
    viRow.appendChild(viLabel);
    viRow.appendChild(viStrong);

    wrapper.appendChild(title);
    wrapper.appendChild(riskRow);
    wrapper.appendChild(populationRow);
    wrapper.appendChild(viRow);

    var fallbackHtml = '<div class="p-3" style="min-width: 280px;">' +
        '<h6 class="fw-bold mb-3" style="color: ' + markerColor + '; border-bottom: 2px solid ' + markerColor + '; padding-bottom: 8px;">' +
        'ğŸ“ ' + escapeHtml(nameText) +
        '</h6>' +
        '<div class="mb-2">' +
        '<span class="text-secondary">é£é™©ç­‰çº§ï¼š</span>' +
        '<span class="badge" style="background-color: ' + markerColor + '; font-size: 0.85rem;">' +
        escapeHtml(riskText) + 'é£é™©</span>' +
        '</div>' +
        '<div class="mb-2">' +
        '<span class="text-secondary">äººå£æ•°é‡ï¼š</span>' +
        '<strong>' + escapeHtml(populationText) + '</strong> äºº' +
        '</div>' +
        '<div class="mb-2">' +
        '<span class="text-secondary">è„†å¼±æ€§æŒ‡æ•°ï¼š</span>' +
        '<strong style="color: ' + markerColor + ';">' + escapeHtml(vulnerabilityText) + '</strong>' +
        '</div>' +
        '</div>';

    return {
        node: wrapper,
        fallback: fallbackHtml
    };
}

function buildRiskInfoContent(riskItem, bgColor) {
    var nameText = safeText(riskItem && riskItem.community, '--');
    var levelText = safeText(riskItem && riskItem.risk_level, '--');
    var scoreText = formatNumber(riskItem && riskItem.risk_score, 1, '--');
    var relativeText = formatNumber(riskItem && riskItem.relative_index, 1, '--');
    var percentileText = formatNumber(riskItem && riskItem.percentile_rank, 1, '--');
    var populationValue = toNumber(riskItem && riskItem.population, null);
    var populationText = populationValue === null ? '--' : Math.round(populationValue).toLocaleString();
    var excessText = formatNumber(riskItem && riskItem.expected_excess_visits, 1, '--');
    var rankText = formatNumber(riskItem && riskItem.rank, 0, '--');

    var wrapper = document.createElement('div');
    wrapper.style.padding = '15px';
    wrapper.style.minWidth = '250px';

    var title = document.createElement('h6');
    title.style.color = bgColor;
    title.style.borderBottom = '2px solid ' + bgColor;
    title.style.paddingBottom = '8px';
    title.style.marginBottom = '12px';
    title.textContent = 'ğŸ˜ï¸ ' + nameText;
    wrapper.appendChild(title);

    var levelRow = document.createElement('div');
    levelRow.style.marginBottom = '8px';
    var levelLabel = document.createElement('span');
    levelLabel.style.color = '#666';
    levelLabel.textContent = 'é£é™©ç­‰çº§ï¼š';
    var levelBadge = document.createElement('span');
    levelBadge.style.background = bgColor;
    levelBadge.style.color = 'white';
    levelBadge.style.padding = '2px 8px';
    levelBadge.style.borderRadius = '10px';
    levelBadge.style.fontSize = '12px';
    levelBadge.textContent = levelText;
    levelRow.appendChild(levelLabel);
    levelRow.appendChild(levelBadge);
    wrapper.appendChild(levelRow);

    var scoreRow = document.createElement('div');
    scoreRow.style.marginBottom = '8px';
    var scoreLabel = document.createElement('span');
    scoreLabel.style.color = '#666';
    scoreLabel.textContent = 'é£é™©åˆ†æ•°ï¼š';
    var scoreStrong = document.createElement('strong');
    scoreStrong.style.color = bgColor;
    scoreStrong.style.fontSize = '18px';
    scoreStrong.textContent = scoreText;
    scoreRow.appendChild(scoreLabel);
    scoreRow.appendChild(scoreStrong);
    wrapper.appendChild(scoreRow);

    var relativeRow = document.createElement('div');
    relativeRow.style.marginBottom = '8px';
    var relativeLabel = document.createElement('span');
    relativeLabel.style.color = '#666';
    relativeLabel.textContent = 'ç›¸å¯¹æŒ‡æ•°ï¼š';
    var relativeStrong = document.createElement('strong');
    relativeStrong.textContent = relativeText;
    relativeRow.appendChild(relativeLabel);
    relativeRow.appendChild(relativeStrong);
    wrapper.appendChild(relativeRow);

    var percentileRow = document.createElement('div');
    percentileRow.style.marginBottom = '8px';
    var percentileLabel = document.createElement('span');
    percentileLabel.style.color = '#666';
    percentileLabel.textContent = 'åˆ†ä½ï¼š';
    var percentileStrong = document.createElement('strong');
    percentileStrong.textContent = percentileText === '--' ? '--' : percentileText + '%';
    percentileRow.appendChild(percentileLabel);
    percentileRow.appendChild(percentileStrong);
    wrapper.appendChild(percentileRow);

    var populationRow = document.createElement('div');
    populationRow.style.marginBottom = '8px';
    var populationLabel = document.createElement('span');
    populationLabel.style.color = '#666';
    populationLabel.textContent = 'äººå£æ•°é‡ï¼š';
    var populationStrong = document.createElement('strong');
    populationStrong.textContent = populationText;
    populationRow.appendChild(populationLabel);
    populationRow.appendChild(populationStrong);
    populationRow.appendChild(document.createTextNode(' äºº'));
    wrapper.appendChild(populationRow);

    var excessRow = document.createElement('div');
    excessRow.style.marginBottom = '8px';
    var excessLabel = document.createElement('span');
    excessLabel.style.color = '#666';
    excessLabel.textContent = 'é¢„è®¡é¢å¤–å°±è¯Šï¼š';
    var excessStrong = document.createElement('strong');
    excessStrong.style.color = '#e74c3c';
    excessStrong.textContent = excessText;
    excessRow.appendChild(excessLabel);
    excessRow.appendChild(excessStrong);
    excessRow.appendChild(document.createTextNode(' äººæ¬¡'));
    wrapper.appendChild(excessRow);

    var rankRow = document.createElement('div');
    rankRow.style.marginTop = '10px';
    rankRow.style.paddingTop = '8px';
    rankRow.style.borderTop = '1px dashed #ddd';
    rankRow.style.fontSize = '11px';
    rankRow.style.color = '#888';
    rankRow.textContent = 'æ’åï¼šç¬¬ ' + rankText + ' ä½';
    wrapper.appendChild(rankRow);

    var fallbackHtml = '<div style="padding: 15px; min-width: 250px;">' +
        '<h6 style="color: ' + bgColor + '; border-bottom: 2px solid ' + bgColor + '; padding-bottom: 8px; margin-bottom: 12px;">' +
        'ğŸ˜ï¸ ' + escapeHtml(nameText) + '</h6>' +
        '<div style="margin-bottom: 8px;">' +
        '<span style="color: #666;">é£é™©ç­‰çº§ï¼š</span>' +
        '<span style="background: ' + bgColor + '; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">' +
        escapeHtml(levelText) + '</span>' +
        '</div>' +
        '<div style="margin-bottom: 8px;">' +
        '<span style="color: #666;">é£é™©åˆ†æ•°ï¼š</span>' +
        '<strong style="color: ' + bgColor + '; font-size: 18px;">' + escapeHtml(scoreText) + '</strong>' +
        '</div>' +
        '<div style="margin-bottom: 8px;">' +
        '<span style="color: #666;">ç›¸å¯¹æŒ‡æ•°ï¼š</span>' +
        '<strong>' + escapeHtml(relativeText) + '</strong>' +
        '</div>' +
        '<div style="margin-bottom: 8px;">' +
        '<span style="color: #666;">åˆ†ä½ï¼š</span>' +
        '<strong>' + escapeHtml(percentileText === '--' ? '--' : percentileText + '%') + '</strong>' +
        '</div>' +
        '<div style="margin-bottom: 8px;">' +
        '<span style="color: #666;">äººå£æ•°é‡ï¼š</span>' +
        '<strong>' + escapeHtml(populationText) + '</strong> äºº' +
        '</div>' +
        '<div style="margin-bottom: 8px;">' +
        '<span style="color: #666;">é¢„è®¡é¢å¤–å°±è¯Šï¼š</span>' +
        '<strong style="color: #e74c3c;">' + escapeHtml(excessText) + '</strong> äººæ¬¡' +
        '</div>' +
        '<div style="margin-top: 10px; padding-top: 8px; border-top: 1px dashed #ddd; font-size: 11px; color: #888;">' +
        'æ’åï¼šç¬¬ ' + escapeHtml(rankText) + ' ä½' +
        '</div>' +
        '</div>';

    return {
        node: wrapper,
        fallback: fallbackHtml
    };
}

// æ·»åŠ åˆå§‹ç¤¾åŒºæ ‡è®°ï¼ˆå¦‚æœæœ‰åæ ‡ï¼‰
communities.forEach(function(community, index) {
    var lat = toNumber(community && community.latitude, null);
    var lng = toNumber(community && community.longitude, null);
    if (Number.isFinite(lat) && Number.isFinite(lng)) {
        var markerColor = getRiskColor(community.risk_level);
        
        // åˆ›å»ºåœ†å½¢è¦†ç›–ç‰©ï¼ˆè¡¨ç¤ºé£é™©èŒƒå›´ï¼‰
        var circle = new AMap.Circle({
            center: [lng, lat],
            radius: getBoundaryRadius(community.name),
            strokeColor: markerColor,
            strokeWeight: 2,
            strokeOpacity: 0.8,
            fillColor: markerColor,
            fillOpacity: 0.25,
            zIndex: 50
        });
        
        // åˆ›å»ºæ–‡å­—æ ‡æ³¨
        var text = new AMap.Text({
            text: community.name,
            position: [lng, lat],
            style: {
                'background-color': markerColor,
                'border': '2px solid white',
                'border-radius': '15px',
                'color': 'white',
                'font-size': '12px',
                'font-weight': 'bold',
                'padding': '4px 10px',
                'box-shadow': '0 2px 6px rgba(0,0,0,0.3)'
            },
            offset: new AMap.Pixel(-30, -15)
        });
        
        // åˆ›å»ºä¿¡æ¯çª—ä½“å†…å®¹
        var infoContent = buildCommunityInfoContent(community, markerColor);
        var infoWindow = createInfoWindowWithContent({
            isCustom: false,
            offset: new AMap.Pixel(0, -25)
        }, infoContent);
        
        text.on('click', function(e) {
            infoWindow.open(map, [lng, lat]);
        });
        
        circle.on('click', function(e) {
            infoWindow.open(map, [lng, lat]);
        });
        
        map.add([circle, text]);
        markers[index] = {
            circle: circle,
            text: text,
            infoWindow: infoWindow,
            community: community
        };
    }
});

// æ·»åŠ é£é™©æ•°æ®æ ‡è®°åˆ°åœ°å›¾
function addRiskMarkers(rankings) {
    // æ¸…é™¤æ—§æ ‡è®°
    riskMarkers.forEach(function(item) {
        map.remove(item.circle);
        map.remove(item.marker);
    });
    riskMarkers = [];
    riskMarkerCoords = {};
    
    rankings.forEach(function(r, index) {
        var coords = communityCoords[r.community];
        if (!coords) {
            // å¦‚æœæ²¡æœ‰é¢„è®¾åæ ‡ï¼Œåœ¨éƒ½æ˜Œå¿èŒƒå›´å†…éšæœºç”Ÿæˆ
            coords = [
                116.10 + Math.random() * 0.30,
                29.15 + Math.random() * 0.30
            ];
        }
        
        var bgColor = r.risk_level === 'é«˜é£é™©' ? '#dc2626' : 
                      r.risk_level === 'ä¸­é£é™©' ? '#d97706' : '#0e9f6e';
        
        // åˆ›å»ºé£é™©èŒƒå›´åœ†åœˆ
        var circle = new AMap.Circle({
            center: coords,
            radius: getBoundaryRadius(r.community),
            strokeColor: bgColor,
            strokeWeight: 2,
            strokeOpacity: 0.9,
            fillColor: bgColor,
            fillOpacity: 0.3,
            zIndex: 50
        });
        
        // åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°
        var markerContent = createMarkerContent(r.community, r.risk_level, r.risk_score);
        var marker = createMarkerWithContent({
            position: coords,
            offset: new AMap.Pixel(-40, -25),
            zIndex: 100
        }, markerContent);
        
        // ä¿¡æ¯çª—å£
        var infoContent = buildRiskInfoContent(r, bgColor);
        var infoWindow = createInfoWindowWithContent({
            isCustom: false,
            offset: new AMap.Pixel(0, -30)
        }, infoContent);
        
        marker.on('click', function() {
            infoWindow.open(map, coords);
        });
        
        circle.on('click', function() {
            infoWindow.open(map, coords);
        });
        
        map.add([circle, marker]);
        if (r.community) {
            riskMarkerCoords[r.community] = coords;
        }
        riskMarkers.push({
            circle: circle,
            marker: marker,
            infoWindow: infoWindow,
            coords: coords,
            community: r.community
        });
    });
    
    // è°ƒæ•´åœ°å›¾è§†é‡ä»¥åŒ…å«æ‰€æœ‰æ ‡è®°
    if (riskMarkers.length > 0) {
        map.setFitView();
    }
}

// ç¤¾åŒºåˆ—è¡¨ç‚¹å‡»äº‹ä»¶
document.querySelectorAll('#community-list .list-group-item').forEach(function(item, index) {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        var lat = toNumber(this.dataset.lat, null);
        var lng = toNumber(this.dataset.lng, null);
        if (Number.isFinite(lat) && Number.isFinite(lng)) {
            map.setZoomAndCenter(14, [lng, lat]);
            
            // æ‰“å¼€å¯¹åº”æ ‡è®°çš„ä¿¡æ¯çª—ä½“
            if (markers[index] && markers[index].infoWindow) {
                markers[index].infoWindow.open(map, [lng, lat]);
            }
        }
    });
});

// åœ°å›¾åŠ è½½å®Œæˆæç¤º
map.on('complete', function() {
    console.log('åœ°å›¾åŠ è½½å®Œæˆ');
    // è‡ªåŠ¨åŠ è½½é£é™©åœ°å›¾æ•°æ®
    loadRiskMap();
});

// åŠ è½½å®æ—¶é£é™©åœ°å›¾æ•°æ®
function loadRiskMap() {
    fetch('/api/community/risk-map-v2', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateRiskDisplay(data);
        }
    })
    .catch(error => {
        console.error('åŠ è½½é£é™©æ•°æ®å¤±è´¥:', error);
    });
}

function clearElement(element) {
    while (element.firstChild) {
        element.removeChild(element.firstChild);
    }
}

const refreshButton = document.getElementById('refreshRiskMap');
if (refreshButton) {
    refreshButton.addEventListener('click', loadRiskMap);
}

function updateRiskDisplay(data) {
    const formatNumber = (value, decimals, fallback) => {
        if (value === undefined || value === null || Number.isNaN(value)) {
            return fallback;
        }
        const num = typeof value === 'number' ? value : parseFloat(value);
        if (Number.isNaN(num)) {
            return fallback;
        }
        return num.toFixed(decimals);
    };

    // æ›´æ–°åœ°å›¾æ ‡è®°
    if (data.rankings && data.rankings.length > 0) {
        clearBaseMarkers();
        addRiskMarkers(data.rankings);
    }
    
    // æ›´æ–°ç¤¾åŒºåˆ—è¡¨
    const listDiv = document.getElementById('community-list');
    if (data.rankings && data.rankings.length > 0) {
        clearElement(listDiv);
        data.rankings.forEach((r, i) => {
            const badgeClass = r.risk_level === 'é«˜é£é™©' ? 'danger' : 
                              r.risk_level === 'ä¸­é£é™©' ? 'warning' : 'success';
            const bgColor = r.risk_level === 'é«˜é£é™©' ? '#dc2626' : 
                           r.risk_level === 'ä¸­é£é™©' ? '#d97706' : '#0e9f6e';

            const item = document.createElement('div');
            item.className = 'list-group-item list-group-item-action';
            item.style.cursor = 'pointer';
            item.style.borderLeft = '4px solid ' + bgColor;
            item.addEventListener('click', function() {
                focusOnCommunity(r.community, i);
            });

            const header = document.createElement('div');
            header.className = 'd-flex justify-content-between align-items-center';

            const left = document.createElement('div');
            const rankBadge = document.createElement('span');
            rankBadge.className = 'badge bg-secondary me-2';
            rankBadge.textContent = '#' + (r.rank !== undefined && r.rank !== null ? r.rank : '--');
            const nameStrong = document.createElement('strong');
            nameStrong.textContent = r.community || '--';
            left.appendChild(rankBadge);
            left.appendChild(nameStrong);

            const riskBadge = document.createElement('span');
            riskBadge.className = 'badge bg-' + badgeClass;
            riskBadge.textContent = r.risk_level || '--';

            header.appendChild(left);
            header.appendChild(riskBadge);

            const info = document.createElement('div');
            info.className = 'small text-muted mt-1';
            const riskScoreText = formatNumber(r.risk_score, 1, '--');
            const relativeIndexText = formatNumber(r.relative_index, 1, '--');
            const percentileText = formatNumber(r.percentile_rank, 1, '--');
            const populationText = (r.population === undefined || r.population === null) ? '--' : String(r.population);
            const excessText = formatNumber(r.expected_excess_visits, 1, '--');

            const riskScoreStrong = document.createElement('strong');
            riskScoreStrong.style.color = bgColor;
            riskScoreStrong.textContent = riskScoreText;

            info.appendChild(document.createTextNode('é£é™©åˆ†æ•°: '));
            info.appendChild(riskScoreStrong);
            info.appendChild(document.createTextNode(' | ç›¸å¯¹æŒ‡æ•°: '));
            info.appendChild(document.createTextNode(relativeIndexText));
            info.appendChild(document.createTextNode(' | åˆ†ä½: '));
            info.appendChild(document.createTextNode(percentileText === '--' ? '--' : percentileText + '%'));
            info.appendChild(document.createTextNode(' | äººå£: '));
            info.appendChild(document.createTextNode(populationText));
            info.appendChild(document.createTextNode(' | é¢å¤–å°±è¯Š: '));
            info.appendChild(document.createTextNode(excessText === '--' ? '--' : excessText + 'äººæ¬¡'));

            item.appendChild(header);
            item.appendChild(info);
            listDiv.appendChild(item);
        });
    }
    
    // æ›´æ–°ç®¡æ§å»ºè®®
    const suggestDiv = document.getElementById('managementSuggestions');
    clearElement(suggestDiv);
    if (data.management_suggestions && data.management_suggestions.length > 0) {
        data.management_suggestions.forEach(s => {
            const priorityClass = s.priority === 'high' ? 'danger' : 
                                 s.priority === 'medium' ? 'warning' : 'info';
            const icon = s.priority === 'high' ? 'ğŸš¨' : 
                        s.priority === 'medium' ? 'âš ï¸' : 'ğŸ’¡';

            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-' + priorityClass + ' py-2 mb-2';

            const title = document.createElement('strong');
            title.textContent = icon + ' ' + (s.category || '');

            const advice = document.createElement('small');
            advice.textContent = s.advice || '';

            alertDiv.appendChild(title);
            alertDiv.appendChild(document.createElement('br'));
            alertDiv.appendChild(advice);
            suggestDiv.appendChild(alertDiv);
        });
    } else {
        const empty = document.createElement('p');
        empty.className = 'text-muted small mb-0';
        empty.textContent = 'æš‚æ— ç®¡æ§å»ºè®®';
        suggestDiv.appendChild(empty);
    }
    
    // æ˜¾ç¤ºæ‘˜è¦
    if (data.summary) {
        console.log('é£é™©æ‘˜è¦:', data.summary);
    }
}

// ç‚¹å‡»åˆ—è¡¨é¡¹èšç„¦åˆ°å¯¹åº”ç¤¾åŒº
function focusOnCommunity(communityName, index) {
    var coords = null;
    if (riskMarkers[index] && riskMarkers[index].coords) {
        coords = riskMarkers[index].coords;
    } else if (communityName && riskMarkerCoords[communityName]) {
        coords = riskMarkerCoords[communityName];
    } else if (communityName) {
        coords = communityCoords[communityName];
    }
    if (coords && coords.length === 2 && Number.isFinite(coords[0]) && Number.isFinite(coords[1])) {
        map.setZoomAndCenter(14, coords);
        // æ‰“å¼€å¯¹åº”æ ‡è®°çš„ä¿¡æ¯çª—å£
        if (riskMarkers[index] && riskMarkers[index].infoWindow) {
            riskMarkers[index].infoWindow.open(map, coords);
        }
    }
}
</script>
{% endblock %}
